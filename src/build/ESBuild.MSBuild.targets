<Project>
    <Target Name="_ESBuildPrepareForRun">
        <PropertyGroup>
            <_ESBuildBundlePath>$(IntermediateOutputPath)esbuild\</_ESBuildBundlePath>
            <_ESBuildBundlePath Condition="'$(ESBuildIntermediatePath)' != ''">
                $(ESBuildIntermediatePath)</_ESBuildBundlePath>
        </PropertyGroup>
    </Target>

    <Target Name="_ESBuildTransform" DependsOnTargets="_ESBuildPrepareForRun" Inputs="@(ESBuild)" Outputs="@(ESBuild -> '$(_ESBuildBundlePath)%(Filename)%(Extension)')">
        <ItemGroup>
            <_ESBundle Include="$(_ESBuildBundlePath)%(ESBuild.Filename)%(ESBuild.Extension)" Src="%(ESBuild.Identity)" />
        </ItemGroup>

        <Exec Command='"$(ESBuildBinaryPath)" %(_ESBundle.Src) --outfile=%(_ESBundle.Identity) --log-level=warning $(ESBuildArguments)'>
            <Output TaskParameter="ExitCode" PropertyName="_ESBuildExitCode" />
        </Exec>

        <Message Condition="$(_ESBuildExitCode) == 0" Importance="high"
                 Text="%(_ESBundle.Src) -> $([System.IO.Path]::GetFullPath('%(_ESBundle.Identity)'))" />
    </Target>

    <Target Name="_ESBuildOutputs" DependsOnTargets="_ESBuildTransform" BeforeTargets="AssignTargetPaths;ResolveProjectStaticWebAssets">
        <ItemGroup Condition="'$(_ESBuildExitCode)' == '0' or '$(_ESBuildExitCode)' == ''">
            <Content Include="@(_ESBundle)" Link="$(ESBuildWebRoot)%(_ESBundle.Src)" />
            <FileWrites Include="@(_ESBundle)" />
            <UpToDateCheckBuilt Include="@(_ESBundle)" Original="%(_ESBundle.Src)" />
        </ItemGroup>
    </Target>

    <Target Name="_ESBuildResetContentRoot" DependsOnTargets="_ESBuildPrepareForRun;ResolveProjectStaticWebAssets" BeforeTargets="GenerateStaticWebAssetsManifest">
        <ItemGroup>
            <StaticWebAsset Condition="$([System.String]::new('%(StaticWebAsset.OriginalItemSpec)').StartsWith($(_ESBuildBundlePath)))">
                <ContentRoot>$(_ESBuildBundlePath)</ContentRoot>
            </StaticWebAsset>
        </ItemGroup>
    </Target>
</Project>
